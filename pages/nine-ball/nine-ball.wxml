<view class="container">
  <view class="top-bar">
    <view class="pill default">第 {{rounds}} 局</view>
    <view class="pill primary">{{modeLabel}}</view>
  </view>

  <view class="timer-container">
    <view class="timer" bindtap="onToggleTimer">
      <text class="timer-text">{{timerText}}</text>
      <text class="timer-status {{isRunning?'paused':''}}">{{isRunning?'暂停':'开始'}}</text>
    </view>
  </view>

  <view class="main-panel">
    <!-- Scores -->
    <view class="score-grid {{players.length==3?'three-players':'two-players'}}">
      <block wx:for="{{players}}" wx:key="id" wx:for-index="idx">
        <view class="player-card {{selectedIndex==idx?'active':''}}" bindtap="onSelectWinner" data-idx="{{idx}}" bindlongpress="onRenameStart" data-idx="{{idx}}">
          <view class="player-name">{{players[idx].name}}</view>
          <view class="player-score">{{players[idx].score}}</view>
        </view>
      </block>
    </view>

    <view class="hint-text">长按玩家姓名可以修改</view>

    <!-- Stats -->
    <view class="stats-grid {{players.length==3?'three-players':'two-players'}}">
      <block wx:for="{{players}}" wx:key="id" wx:for-index="idx">
        <view class="stat-column">
          <view class="stat-items-row">
            <view class="stat-item">
               <text class="stat-val text-danger">{{players[idx].counts.foul}}</text>
               <text class="stat-label">犯规</text>
            </view>
            <view class="stat-item">
               <text class="stat-val text-primary">{{players[idx].counts.normal}}</text>
               <text class="stat-label">普胜</text>
            </view>
             <view class="stat-item">
               <text class="stat-val text-warning">{{players[idx].counts.xiaojin}}</text>
               <text class="stat-label">小金</text>
            </view>
             <view class="stat-item">
               <text class="stat-val text-amber">{{players[idx].counts.dajin}}</text>
               <text class="stat-label">大金</text>
            </view>
             <view class="stat-item">
               <text class="stat-val text-yellow">{{players[idx].counts.huangjin9}}</text>
               <text class="stat-label">黄9</text>
            </view>
          </view>
        </view>
      </block>
    </view>
  </view>

  <view class="action-grid">
    <view class="btn-score bg-danger" bindtap="onOp" data-type="foul" disabled="{{!hasStarted}}">犯规</view>
    <view class="btn-score bg-primary" bindtap="onOp" data-type="normal" disabled="{{!hasStarted}}">普胜</view>
    <view class="btn-score bg-warning" bindtap="onOp" data-type="xiaojin" disabled="{{!hasStarted}}">小金</view>
    <view class="btn-score bg-amber" bindtap="onOp" data-type="dajin" disabled="{{!hasStarted}}">大金</view>
    <view class="btn-score bg-yellow" bindtap="onOp" data-type="huangjin9" disabled="{{!hasStarted}}">黄金9</view>
  </view>

  <view class="footer">
    <view class="btn-control" bindtap="onUndo" disabled="{{history.length==0}}">
      <t-icon name="rollback" size="32rpx" /> 撤销
    </view>
    <view class="btn-control" bindtap="onRestart">
      <t-icon name="refresh" size="32rpx" /> 重开
    </view>
    <view class="btn-control danger" bindtap="onEndMatch">
      <t-icon name="stop-circle" size="32rpx" /> 结束
    </view>
    <view class="btn-control" bindtap="openSettings">
      <t-icon name="setting" size="32rpx" /> 设置
    </view>
  </view>

  <!-- Settings Modal -->
  <view class="modal-mask" wx:if="{{settingsVisible}}">
    <view class="modal-content">
      <view class="modal-title">设置追分规则</view>
      <view class="modal-body">
        <view class="form-row"><text class="form-label">犯规扣分</text><input class="input-field" type="number" value="{{rulesForm.foul}}" bindinput="onRuleInput" data-key="foul"/></view>
        <view class="form-row"><text class="form-label">普胜得分</text><input class="input-field" type="number" value="{{rulesForm.normal}}" bindinput="onRuleInput" data-key="normal"/></view>
        <view class="form-row"><text class="form-label">小金得分</text><input class="input-field" type="number" value="{{rulesForm.xiaojin}}" bindinput="onRuleInput" data-key="xiaojin"/></view>
        <view class="form-row"><text class="form-label">大金得分</text><input class="input-field" type="number" value="{{rulesForm.dajin}}" bindinput="onRuleInput" data-key="dajin"/></view>
        <view class="form-row"><text class="form-label">黄金9得分</text><input class="input-field" type="number" value="{{rulesForm.huangjin9}}" bindinput="onRuleInput" data-key="huangjin9"/></view>
      </view>
      <view class="modal-footer">
        <button class="btn-modal cancel" bindtap="closeSettings">取消</button>
        <button class="btn-modal confirm" bindtap="saveSettings">确定</button>
      </view>
    </view>
  </view>

  <!-- Loser Modal -->
  <view class="modal-mask" wx:if="{{loserVisible}}">
    <view class="modal-content">
      <view class="modal-title">选择输家</view>
      <view class="loser-grid">
        <block wx:for="{{loserCandidates}}" wx:key="idx">
          <view class="loser-avatar {{selectedLoserIndex==item? 'selected': ''}}" bindtap="pickLoser" data-idx="{{item}}">
            {{players[item].name}}
          </view>
        </block>
      </view>
      <view class="modal-footer">
        <button class="btn-modal cancel" bindtap="cancelPickLoser">取消</button>
      </view>
    </view>
  </view>

  <!-- Winner Modal -->
  <view class="modal-mask" wx:if="{{winnerVisible}}">
    <view class="modal-content">
      <view class="modal-title">选择赢家</view>
      <view class="loser-grid">
        <block wx:for="{{winnerCandidates}}" wx:key="idx">
          <view class="loser-avatar {{selectedWinnerIndex==item? 'selected': ''}}" bindtap="pickWinner" data-idx="{{item}}">
            {{players[item].name}}
          </view>
        </block>
      </view>
      <view class="modal-footer">
        <button class="btn-modal cancel" bindtap="cancelPickWinner">取消</button>
      </view>
    </view>
  </view>

  <!-- Rename Modal -->
  <view class="modal-mask" wx:if="{{renameVisible}}">
    <view class="modal-content">
      <view class="modal-title">修改玩家姓名</view>
      <view class="modal-body">
         <input class="input-field full" type="text" placeholder="请输入姓名" value="{{renameValue}}" bindinput="onRenameInput" confirm-type="done" />
      </view>
      <view class="modal-footer">
        <button class="btn-modal cancel" bindtap="onRenameCancel">取消</button>
        <button class="btn-modal confirm" bindtap="onRenameSave">保存</button>
      </view>
    </view>
  </view>
</view>
